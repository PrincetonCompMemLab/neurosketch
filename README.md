# Goal of study 
How are visual production and visual recognition of objects related in the brain?
How does visual production training influence organization of neural object representations?

# Experimental procedure

10 runs in total: 2 (localizer recognition runs) + 2 (pre recognition runs) + 4 (drawing runs) + 2 (post recognition runs)

4 objects: bed, bench chair, table.
Viewed each object 20 times per run during recognition runs. Trial ISI jittered. 
Two objects drawn in alternating sequence during drawing runs. Each drawing trial lasted 23 TR’s.

# Scanning parameters & sequence information

see: `/metadata/fmri_sequence_info`

# fMRI data preprocessing
    Note: ALL OF THE OUTPUTS FROM THIS STAGE HAVE BEEN PROVIDED AND ARE 
    READILY AVAILABLE, SO THESE STEPS ARE NOT NECESSARY

### INPUT:
* DICOM archives for each subject: `data/raw/$SUBJ/raw.tar.gz`
* Regressor files for each object for each recognition run: `data/regressor/$SUBJ/$RUN/$object.txt`
* Regressor files for each object for the drawing runs (same across runs): `data/regressor/$SUBJ/production/$object.txt`  
.nii.gz, .bxh files, and trial metadata stored on mongo (currently hosted on kanefsky)
* Run order files for each subject: `data/run-orders/$SUBJ/run-order.txt`

### RUNNING:
*Note: Follows generally from [neuropipe framework](https://github.com/ntblab/neuropipe)*

* This analysis assumes you have conda, FSL 6.0.1, BXH, Matlab and Freesurfer installed

* To start, create a conda environment using the provided file:
	
	$ conda env create -f environment.yml

* There will be cluster-specific changes required. Specifically, if you open `preprocessing/prototype/link/globals.sh`, 
you'll find the following paths that will need to be updated to reflect the appropriate locations for BXH/XCEDE Tools, ImageMagick, 
BIAC Matlab Tools respectively.

        # add necessary directories to the system path
        export BXH_DIR=/jukebox/ntb/packages/bxh_xcede_tools/bin
        export MAGICK_HOME=/jukebox/ntb/packages/ImageMagick-6.5.9-9
        export BIAC_HOME=/jukebox/ntb/packages/BIAC_matlab/mr

* In `analysis/preprocessing`, there is a script called `scaffold`, which generates a new directory 
in `analysis/preprocessing/subjects/` when run, pulling raw data, run-order files and regressor 
files into their appropraite locations. This script duplicates a folder structure, and copies or links 
a number of analysis scripts contained in the `analysis/preprocessing/prototype` folder.
* The main handler script to run an entire subjects' analysis is `drawing.sh`, which is copied into the
newly created `analysis/preprocessing/subjects/$SUBJ` directory. This script will:
    1. Complete some basic preparation (`prep.sh`), including:
        1. convert data to nifti (`scripts/convert-and-wrap-raw-data.sh`)
        2. run quality assurance (`scripts/qa-wrapped-data.sh`)
        3. reorient data to radiological convention (`scripts/reorient-to-las.sh`)
    2. Create `.fsf` files to feed in to FSL and run low-level feat analyses:
        1. For recognition runs (`scripts/render_fsf_templates_glm4.sh`) 
        2. and production runs (`scripts/render_fsf_templates_draw.sh`)
    3. Skull strip the subjects' T1 scans (`brain_extract_first.sh`)
    4. Start freesurfer's `recon-all` to later develop anatomical ROIs
    5. Run FSL's `feat` for every recognition and production run. These are stored in the directory 
    `analysis/firstlevel/${RUN}.feat`
    6. Run a script that awaits the string "Finished at" in the `report.html` file generated by `feat` 
    for each run (`scripts/wait-for-feat.sh`) before advancing
    7. Renders a template for the second level analysis, which combines across all of the production runs,
    then runs the second level `feat`, which will be stored in the directory `analysis/secondlevel/draw.gfeat`
    8. Converts recognition cope maps (`scripts/convert_copes.sh`) and filtered functional data (`scripts/flirt_filt.sh`)
    9. Wait for confirmation that freesurfer has finished (`scripts/wait-for-surf.sh`)
    10. Creates ROI masks based on freesurfer results (`scripts/surfROI.sh`)
    11. Creates feature matrices and metadata for recognition (`scripts.recog_features.py`) and production 
    (`scripts/draw_features.py`) runs
* Within `analysis/preprocessing`, one can batch `scaffold` and subsequently batch run `drawing.sh`
in all subjects, using the following steps:

        $ cd analysis/preprocessing
        $ sbatch scripts/scaffold_all.sh
        
        # wait until finished
        
        $ sbatch scripts/analyze_all.sh
        
* To check in on which analysis stage was most recently completed for each of the subjects' analyses, 
one can run:

        $ bash scripts/checkin.sh
        
* Once all subjects are completed, the next step is to run group-level production run analyses. This 
next script will create a production run univariate task mask for each held out subject, derived from all
of the remaining subjects' lower level analyses. With these individualized task masks, the intersect with
subjects' anatomical ROIs are computed and connectivity features generated. To accomplish this, one can run:

        $  sbatch scripts/lv1out.sh
        
* If all has run successfully, all of the following output should be present.

<!---
Motion correction
Projection of filtered_func into anatomical space to yield 4D timeseries
ROIs:
Freesurfer used to derive ROIs from each participants’ T1
Univariate comparison (drawing vs. not drawing) used to make task mask
ROIs with ‘draw’ suffix are intersects of ROI masks and draw task mask
All in anatomical space
-->

### OUTPUT: 
	For each subject and phase (e.g. 12, 34, or 56):
* Voxel matrices (m timepoints x n voxels) saved as .npy for each region of interest (ROI).
    * e.g. `data/features/recognition/$SUBJ_$ROI_$PHASE_featurematrix.npy`
    * or `data/features/production/$SUBJ_$ROI_$PHASE_featurematrix.npy`
* Connectivity matrices (m trials x n correlations, where n is the product of # voxels in ROI1 and # voxels in ROI2), saved as .npy
    * e.g. `data/features/connectivity/$SUBJ_$ROI1_$ROI2_$PHASE_featurematrix.npy`
* Metadata (m timepoints x 4 columns `[subj,label,run_num,TR_num]`) saved as .csv
    * e.g. `data/features/recognition/metadata_$SUBJ_$ROI_$PHASE.csv`
    * or `data/features/production/metadata_$SUBJ_$ROI_$PHASE.csv`
    * or `data/features/connectivity/metadata_$SUBJ_$PHASE.csv`
* ROI Masks for each ROI saved as niftis
    * For those derived from freesurfer: `rois/freesurfer/$SUBJ_ROI.nii.gz`
    * For those derived from production univariate task masks `rois/production/$SUBJ_draw_task_mask.nii.gz`
    * For those derived from intersect between freesurfer and univariate masks: `rois/intersect/$SUBJ_${ROI}Draw.nii.gz`
<!---Note: before 4/23/18, canonical voxel matrices + metadata were in `neurosketch/data/neurosketch_voxelmat3mm_freesurfer_drawing`, renamed to `neurosketch/data/features/drawing`. 

    Note: path on jukebox (accessible via Spock) is: `/jukebox/ntb/projects/sketchloop02/data`
-->
# Main analyses 

## INPUT to analysis:

There is a master DATA dir containing all processed fMRI data in standard format:
* `DATA/features` contains all feature matrices and metadata from all phases, ROIs, and subjects.
	* `DATA/features/drawing` includes drawing filtered func data (represented as .npy feature matrices) + corresponding metadata from full freesurfer anatomical ROIs.
	* Also includes drawing filtered func data + metadata from freesurfer ROIs intersected with drawing taskGLM group-level cope map
	* `DATA/features/recog` contains recognition filtered func data (represented as .npy feature matrices) + corresponding metadata
* `DATA/copes` contains all cope NIFTI files from GLM fit to recognition and drawing runs for all subjects.
	* `DATA/copes/recog/objectGLM` recognition cope maps from object GLM
	* `DATA/copes/draw/taskGLM` drawing cope maps from drawing_task GLM

# List of main analysis notebooks:
1. Measure Object Evidence on Recognition Run Data in Visual Cortex

2. Measure Object Evidence on Drawing Run Data in Visual Cortex

3. Measure Patterns of Connectivity Between Early Visual and Parietal Regions

